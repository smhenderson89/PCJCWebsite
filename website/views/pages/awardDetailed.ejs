<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
    <title><%= title %></title>
    <%
    // Helper function to process award descriptions and create links
    function processAwardDescription(description, currentYear) {
      if (!description) return '';
      
      // Regex to find potential award numbers (at least 8 digits)
      const awardRegex = /\b(\d{8,})\b/g;
      
      return description.replace(awardRegex, (match) => {
        const awardNum = match;
        
        // Extract year from award number (first 4 digits)
        const awardYear = parseInt(awardNum.substring(0, 4), 10);
        
        // Validate: must be at least 8 digits and year must match current award's year
        if (awardNum.length >= 8 && awardYear === parseInt(currentYear, 10)) {
          return `<a href="/award/${awardYear}/${awardNum}" class="award-reference-link" data-award="${awardNum}" data-year="${awardYear}">${awardNum}</a>`;
        }
        
        return match; // Return unchanged if not valid
      });
    }
    %>
</head>
<body class="container">

<header>
  <%- include('../partials/header'); %>
</header>

<main>
  <% if (error) { %>
    <!-- Error Display -->
    <div class="alert alert-danger mt-4">
      <h4 class="alert-heading">‚ùå Error</h4>
      <p class="mb-0"><%= error %></p>
      <hr>
      <p class="mb-0">
        <a href="/awardslist" class="btn btn-primary">‚Üê Back to Awards</a>
        <% if (year) { %>
          <a href="/awards/<%= year %>" class="btn btn-outline-primary">View <%= year %> Awards</a>
        <% } %>
      </p>
    </div>
  <% } else { %>
    <!-- Unified Award Display - works for both server and client-side data -->
    <div class="row mt-4">
      <div class="col-12">
        <!-- Back navigation -->
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/awardslist">Awards</a></li>
            <% if (award && year) { %>
              <li class="breadcrumb-item"><a href="/awards/<%= year %>"><%= year %></a></li>
              <li class="breadcrumb-item active" aria-current="page">Award <%= award.awardNum %></li>
            <% } else { %>
              <li class="breadcrumb-item"><a href="#" id="year-link">Year</a></li>
              <li class="breadcrumb-item active" aria-current="page">Award <span id="breadcrumb-award-num">Loading...</span></li>
            <% } %>
          </ol>
        </nav>
      </div>
    </div>

    <div class="card shadow mt-3" id="award-card"<% if (!award) { %> style="display: none;"<% } %>>
      <div class="card-header text-center">
        <h4 class="mb-0"> Award <span id="award-number">
          <% if (award) { %>
            <%= award.awardNum %>
          <% } else { %>
            Loading...
          <% } %>
        </span></h4>
      </div>
      <div class="card-body">
        <!-- Image Container with Better Centering -->
        <div class="award-image-container">
          <!-- Bootstrap placeholder while loading -->
          <div id="image-placeholder" class="placeholder-glow"<% if (award) { %> style="display: none;"<% } %>>
            <div class="placeholder rounded shadow"></div>
          </div>
            
          <!-- Actual image -->
          <% if (award && award.photo) { %>
            <img id="award-photo" 
                 src="<%= award.photo.replace('database/images/', '/images/') %>" 
                 class="rounded shadow" 
                 alt="Award <%= award.awardNum %>">
            <p class="text-muted mt-2 small text-center position-absolute" id="photo-caption" style="display: none; bottom: -30px; left: 50%; transform: translateX(-50%);"></p>
          <% } else if (award) { %>
            <img id="award-photo" 
                 src="/images/icons8-no-image-100.png" 
                 class="rounded shadow" 
                 alt="Default orchid image">
            <p class="text-muted mt-2 small text-center position-absolute" id="photo-caption" style="bottom: -30px; left: 50%; transform: translateX(-50%);">No photo available</p>
          <% } else { %>
            <img id="award-photo" 
                 src="" 
                 class="rounded shadow d-none" 
                 alt="Award Photo">
            <p class="text-muted mt-2 small text-center position-absolute" id="photo-caption" style="bottom: -30px; left: 50%; transform: translateX(-50%);">Loading image...</p>
          <% } %>
        </div>

            <!-- Award Details Below Image -->
            <!-- Line 1: Genus Species 'Clone' -->
            <div class="text-center mb-2" id="genus-species-display" 
                 <% if (award && (award.genus || award.species || award.clone)) { %>
                   style="display: block;"
                 <% } else { %>
                   style="display: none;"
                 <% } %>>
                <span id="award-genus">
                  <% if (award && award.genus) { %>
                    <%= award.genus %>
                  <% } %>
                </span>
                <span id="award-species">
                  <% if (award && award.species) { %>
                    <%= ' ' + award.species %>
                  <% } %>
                </span>
                <span id="award-clone">
                  <% if (award && award.clone) { %>
                    <%= " '" + award.clone + "'" %>
                  <% } %>
                </span>
            </div>
            
            <!-- Line 2: Cross Information -->
            <div class="text-center mb-2" id="cross-info-display" 
                 <% if (award && award.cross) { %>
                   style="display: block;"
                 <% } else { %>
                   style="display: none;"
                 <% } %>>
                <em id="cross-info-text">
                  <% if (award && award.cross) { %>
                    <%= award.cross %>
                  <% } %>
                </em>
            </div>
            
            <!-- Line 3: Award Name and Points -->
            <div class="text-center mb-4" id="award-name-display" 
                 <% if (award && (award.award || award.awardpoints)) { %>
                   style="display: block;"
                 <% } else { %>
                   style="display: none;"
                 <% } %>>
  
                <span id="award-name">
                  <% if (award && award.award) { %>
                    <%= award.award %>
                  <% } %>
                </span>
                <span id="award-points">
                  <% if (award && award.awardpoints) { %>
                    <%= ' ' + award.awardpoints %>
                  <% } %>
                </span>
            </div>
            
            <!-- Additional Details Section -->
            <div class="row mb-4">
              <div class="col-sm-6">
                <p><strong>Date:</strong> <span id="award-date">
                  <% if (award) { %>
                    <% if (award.date) { %>
                      <%= award.date %>
                    <% } else if (award.date_iso) { %>
                      <%= new Date(award.date_iso).toLocaleDateString() %>
                    <% } else { %>
                      Unknown
                    <% } %>
                  <% } else { %>
                    Unknown
                  <% } %>
                </span></p>
                <p><strong>Location:</strong> <span id="award-location">
                  <% if (award) { %>
                    <%= award.location || 'Unknown' %>
                  <% } else { %>
                    Unknown
                  <% } %>
                </span></p>
              </div>
              <div class="col-sm-6">
                <p><strong>Exhibitor:</strong> 
                  <% if (award && award.exhibitor && award.exhibitor !== 'Not specified') { %>
                    <a href="/awards/exhibitor/<%= encodeURIComponent(award.exhibitor) %>" id="award-exhibitor">
                      <%= award.exhibitor %>
                    </a>
                  <% } else if (award) { %>
                    <span id="award-exhibitor">Not specified</span>
                  <% } else { %>
                    <span id="award-exhibitor">Not specified</span>
                  <% } %>
                </p>
                <p><strong>Photographer:</strong> <span id="award-photographer">
                  <% if (award) { %>
                    <%= award.photographer || 'Not specified' %>
                  <% } else { %>
                    Not specified
                  <% } %>
                </span></p>
              </div>
            </div>
            
            <!-- Award Description Section -->
            <div class="mt-4" id="description-section"
                 <% if (award && award.description) { %>
                   style="display: block;"
                 <% } else { %>
                   style="display: none;"
                 <% } %>>
              <h5><strong>Description:</strong></h5>
              <div class="description-box p-3" id="award-description">
                <% if (award && award.description) { %>
                  <%- processAwardDescription(award.description, award.year) %>
                <% } %>
              </div>
            </div>

            <!-- Measurements Table Section -->
            <div class="mt-4" id="measurements-section"
                 <% 
                 let hasMeasurements = false;
                 if (award) {
                   const measurements = ['NS', 'NSV', 'DSW', 'DSL', 'PETW', 'PETL', 'LSW', 'LSL', 'LIPW', 'LIPL', 'SYNSW', 'SYNSL', 'PCHW', 'PCHL'];
                   hasMeasurements = measurements.some(field => award[field]);
                 }
                 %>
                 <% if (hasMeasurements) { %>
                   style="display: block;"
                 <% } else { %>
                   style="display: none;"
                 <% } %>>
              <h5><strong>Measurements (in cm):</strong></h5>
              <div class="measurements-table-container">
                <table class="table table-striped measurements-table" id="measurements-table">
                  <tbody>
                    <!-- Primary measurements always shown first if available -->
                    <% if (award && award.NS) { %>
                      <tr><td><strong>Natural Spread:</strong></td><td><span id="measurement-ns"><%= award.NS %></span></td></tr>
                    <% } %>
                    <% if (award && award.NSV) { %>
                      <tr><td><strong>Natural Spread Vertical:</strong></td><td><span id="measurement-nsv"><%= award.NSV %></span></td></tr>
                    <% } %>
                    <% if (award && award.DSW) { %>
                      <tr><td><strong>Dorsal Sepal Width:</strong></td><td><span id="measurement-dsw"><%= award.DSW %></span></td></tr>
                    <% } %>
                    <% if (award && award.DSL) { %>
                      <tr><td><strong>Dorsal Sepal Length:</strong></td><td><span id="measurement-dsl"><%= award.DSL %></span></td></tr>
                    <% } %>
                    <% if (award && award.PETW) { %>
                      <tr><td><strong>Petal Width:</strong></td><td><span id="measurement-petw"><%= award.PETW %></span></td></tr>
                    <% } %>
                    <% if (award && award.PETL) { %>
                      <tr><td><strong>Petal Length:</strong></td><td><span id="measurement-petl"><%= award.PETL %></span></td></tr>
                    <% } %>
                    
                    <!-- Lateral Sepal and Lip measurements (if valid) -->
                    <% 
                    let hasLateralLip = false;
                    if (award && (award.LSW || award.LSL || award.LIPW || award.LIPL)) {
                      hasLateralLip = true;
                    }
                    %>
                    <% if (hasLateralLip) { %>
                      <% if (award.LSW) { %>
                        <tr><td><strong>Lateral Sepal Width:</strong></td><td><span id="measurement-lsw"><%= award.LSW %></span></td></tr>
                      <% } %>
                      <% if (award.LSL) { %>
                        <tr><td><strong>Lateral Sepal Length:</strong></td><td><span id="measurement-lsl"><%= award.LSL %></span></td></tr>
                      <% } %>
                      <% if (award.LIPW) { %>
                        <tr><td><strong>Lip Width:</strong></td><td><span id="measurement-lipw"><%= award.LIPW %></span></td></tr>
                      <% } %>
                      <% if (award.LIPL) { %>
                        <tr><td><strong>Lip Length:</strong></td><td><span id="measurement-lipl"><%= award.LIPL %></span></td></tr>
                      <% } %>
                    <% } %>
                    
                    <!-- Synsepal and Pouch measurements (alternative to lateral/lip) -->
                    <% 
                    let hasSynsepalPouch = false;
                    if (award && !hasLateralLip && (award.SYNSW || award.SYNSL || award.PCHW || award.PCHL)) {
                      hasSynsepalPouch = true;
                    }
                    %>
                    <% if (hasSynsepalPouch) { %>
                      <% if (award.SYNSW) { %>
                        <tr><td><strong>Synsepal Width:</strong></td><td><span id="measurement-synsw"><%= award.SYNSW %></span></td></tr>
                      <% } %>
                      <% if (award.SYNSL) { %>
                        <tr><td><strong>Synsepal Length:</strong></td><td><span id="measurement-synsl"><%= award.SYNSL %></span></td></tr>
                      <% } %>
                      <% if (award.PCHW) { %>
                        <tr><td><strong>Pouch Width:</strong></td><td><span id="measurement-pchw"><%= award.PCHW %></span></td></tr>
                      <% } %>
                      <% if (award.PCHL) { %>
                        <tr><td><strong>Pouch Length:</strong></td><td><span id="measurement-pchl"><%= award.PCHL %></span></td></tr>
                      <% } %>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Measurement Data Inclusion for server-side data -->
    <% if (award) { %>
      <div class="mt-4">
        <%- include('../partials/plantdata'); %>
      </div>
    <% } %>

    <!-- Loading state (only shown for client-side loading) -->
    <% if (!award) { %>
    <div class="alert alert-info mt-4" id="loading-alert">
      <h4 class="alert-heading">üîÑ Loading Award Data...</h4>
      <p class="mb-0">Fetching award information from cache or API...</p>
      <div class="spinner-border spinner-border-sm mt-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Error state -->
    <div class="alert alert-danger mt-4" style="display: none;" id="error-alert">
      <h4 class="alert-heading">‚ùå Error Loading Award</h4>
      <p class="mb-0" id="error-message">Unable to load award information.</p>
      <hr>
      <p class="mb-0">
        <a href="/awardslist" class="btn btn-primary">‚Üê Back to Awards</a>
        <a href="#" id="year-awards-link" class="btn btn-outline-primary">View Year Awards</a>
      </p>
    </div>

    <!-- No data state -->
    <div class="alert alert-info mt-4" style="display: none;" id="no-data-alert">
      <h4 class="alert-heading">‚ÑπÔ∏è No Award Data</h4>
      <p class="mb-0">No award information available for the specified parameters.</p>
      <hr>
      <p class="mb-0">
        <a href="/awardslist" class="btn btn-primary">‚Üê Back to Awards</a>
      </p>
    </div>
    <% } %>
  <% } %>
</main>

<footer>
  <%- include('../partials/footer'); %>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- Include award-detailed.js for client-side sessionStorage logic -->
<% if (!award && !error) { %>
<script src="/js/pages/award-detailed.js"></script>
<% } %>
</body>
</html>
